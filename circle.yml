machine:
  ruby:
    version: 2.1.3

dependencies:
  cache_directories:
    - onestop-id-report-builder
  post:
    - if cd $HOME/transitland-feed-registry/onestop-id-report-builder; then git pull; else git clone git@github.com:transitland/onestop-id-report-builder.git $HOME/transitland-feed-registry/onestop-id-report-builder; fi
    - cd $HOME/transitland-feed-registry/onestop-id-report-builder && bundle install
    # TODO: make sure those bundles are getting cached
    - gem install transitland_feed_registry_validator

database:
  override:
    - echo "we need no database"

test:
  override:
    - TRANSITLAND_FEED_REGISTRY_PATH=$HOME/transitland-feed-registry transitland_feed_registry_validator

deployment:
  production:
    branch: master
    commands:
      - cd $HOME/transitland-feed-registry/onestop-id-report-builder && ONESTOP_ID_REGISTRY_LOCAL_PATH=$HOME/transitland-feed-registry bundle exec rake report:build
      - cd $HOME/transitland-feed-registry/onestop-id-report-builder && bundle exec rake report:upload
      - rm -rf $HOME/transitland-feed-registry/onestop-id-report-builder/report/*
